#!/usr/bin/bash

# ./colorscheme <img> <theme>

hypr_colors() {
  inactive_border=$(echo -n "$1" | jq -r '.colors.color1' | tr '[:upper:]' '[:lower:]')
  neutral_border=$(echo -n "$1" | jq -r '.colors.color2' | tr '[:upper:]' '[:lower:]')
  active_border=$(echo -n "$1" | jq -r '.colors.color4' | tr '[:upper:]' '[:lower:]')

  conf=$(echo "c_gen_$2conf")
  conf_path="$HOME/.config/hypr/colours/$conf"

  echo "# generated by ~/.config/hypr/scripts/gen-colorscheme script, based on"                                                    > $conf_path
  echo "# $3"                                                                                                                     >> $conf_path
  echo ""                                                                                                                         >> $conf_path
  echo "general {"                                                                                                                >> $conf_path
  echo "  col.active_border = rgba("${inactive_border#*#}ff") rgba("${neutral_border#*#}ff") rgba("${active_border#*#}ff") 60deg" >> $conf_path
  echo "  col.inactive_border = rgba("${inactive_border#*#}ee")"                                                                  >> $conf_path
  echo "}"                                                                                                                        >> $conf_path
  echo "wrote hyprland color configuration to $conf_path"
}


# check if there is at least one argument
if [[ "$#" -le 0 && "$#" -gt 2 ]]; then
  echo "usage: $0 <image_path> <theme>"
  echo "theme: light(l), dark(d) (by default dark)"
  exit 1
fi

image_path=$1
theme=$2

# check if the file exists
if [ ! -f "$image_path" ]; then
  echo "error: File '$image_path' does not exist."
  exit 1
fi

theme_param=''

# check if theme should be dark (default) or light
if [[ "$theme" == "dark" || "$theme" == "d" || "$theme" == "" ]]; then
  echo "generating dark theme based on $image_path"
elif [[ "$theme" == "light" || "$theme" == "l" ]]; then
  echo "generating light theme based on $image_path"
  theme_param='-l'
else
  echo "invalid argument"
fi

wal -i "$image_path" $theme_param -n -t -s -e -q
generated_theme=$(cat ~/.cache/wal/colors.json | jq -c -M)
image_name=$(basename -s "${image_path#*.}" "$image_path")

hypr_colors $generated_theme $image_name $(basename "$image_path")
